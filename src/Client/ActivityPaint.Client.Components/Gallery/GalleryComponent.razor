@using ActivityPaint.Application.BusinessLogic.Gallery
@using ActivityPaint.Application.DTOs.Preset
@using ActivityPaint.Client.Components.Shared.Services
@using ActivityPaint.Client.Components.Shared.Utilities
@using Mediator
@inject IFeedbackService FeedbackService
@inject IMediator Mediator

<MudGrid Justify="Justify.Center">
    @foreach (var item in _items)
    {
        <MudItem xs="12" sm="6" lg="4">
            <GalleryItemComponent Item="item" ParentReadyListener="_itemsReadyTrigger" DeleteCallback="Delete" />
        </MudItem>
    }
    <MudFlexBreak />
    <MudPagination @bind-Selected:get="_page" @bind-Selected:set="PageChange" Count="_pageCount" Class="mt-2" />
</MudGrid>

@code {
    private const int _pageSize = 18;
    private int _itemsCount = 0;
    private int _pageCount => (int)Math.Ceiling(Decimal.Divide(_itemsCount, _pageSize));
    private int _page = 1;
    private IEnumerable<PresetModel> _items = [];
    private AsyncTrigger _itemsReadyTrigger = new();

    protected override async Task OnInitializedAsync()
    {
        await Task.Factory.StartNew(async () => {
            await UpdateItemsCount();
            await LoadPage();
        });

        await base.OnInitializedAsync();
    }

    private async Task UpdateItemsCount()
    {
        var command = new GetGalleryItemsCountCommand();
        var result = await Mediator.Send(command);

        if (result.IsFailure)
        {
            FeedbackService.ShowError(result.Error);
            return;
        }

        _itemsCount = result.Value;
    }

    private async Task PageChange(int newPage)
    {
        _page = newPage;
        await LoadPage();
    }

    private async Task LoadPage()
    {
        var command = new LoadGalleryItemsCommand(_page, _pageSize);
        var result = await Mediator.Send(command);

        if (result.IsFailure || result.Value is null)
        {
            FeedbackService.ShowError(result.Error);
            return;
        }

        _items = result.Value;
        await Task.Delay(1);
        await _itemsReadyTrigger.Notify();
    }

    private async Task Delete(PresetModel item)
    {
        throw new NotImplementedException();
    }
}
